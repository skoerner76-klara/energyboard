<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Energie-Monitor - Stable Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --pv: #f1c40f; --feedin: #e67e22; --house: #2ecc71; --wp: #9b59b6; --grid: #e74c3c; --usage: #2980b9; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #2c3e50; }
        .container { max-width: 1600px; margin: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; border-bottom: 4px solid #ddd; }
        .stat-card h3 { font-size: 0.72em; text-transform: uppercase; color: #7f8c8d; margin: 0; white-space: nowrap; }
        .stat-card p { margin: 8px 0 0; font-size: 1.25em; font-weight: bold; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .main-chart-container { height: 500px; position: relative; }
        .side-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .side-chart-container { height: 350px; position: relative; }
        .full-chart-container { height: 350px; position: relative; }
        .upload-area { background: #fff; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; border: 3px dashed #3498db; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center">ðŸ“Š Energie- & Heizungs-Analyse</h1>
    
    <div class="upload-area">
        <input type="file" id="fileInput" multiple accept=".csv">
        <div id="statusLine" style="margin-top:10px; font-weight:bold; color: #3498db;">Dateien auswÃ¤hlen oder automatischer Server-Ladevorgang...</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card" style="border-color: var(--house)"><h3>Autarkie</h3><p id="txtAutarky">-</p></div>
        <div class="stat-card" style="border-color: var(--feedin)"><h3>JAZ (Ã˜)</h3><p id="txtJaz">-</p></div>
        <div class="stat-card" style="border-color: var(--usage)"><h3>PV Nutzung (%)</h3><p id="txtPvUsagePct">-</p></div>
        <div class="stat-card" style="border-color: var(--pv)"><h3>PV Erzeugung</h3><p id="txtPvTotal">-</p></div>
        <div class="stat-card" style="border-color: var(--usage)"><h3>PV Nutzung (kWh)</h3><p id="txtPvUsageKwh">-</p></div>
        <div class="stat-card" style="border-color: var(--wp)"><h3>WP Strom</h3><p id="txtWpTotal">-</p></div>
        <div class="stat-card" style="border-color: var(--grid)"><h3>Netzbezug</h3><p id="txtGridTotal">-</p></div>
    </div>

    <div class="chart-card">
        <h2>Energiebilanz (kWh)</h2>
        <div class="main-chart-container"><canvas id="chartMain"></canvas></div>
    </div>

    <div class="side-charts">
        <div class="chart-card"><h2>Monats-JAZ</h2><div class="side-chart-container"><canvas id="chartEff"></canvas></div></div>
        <div class="chart-card"><h2>Ã˜ Temperaturen (Â°C)</h2><div class="side-chart-container"><canvas id="chartHeizBalken"></canvas></div></div>
    </div>

    <div class="chart-card">
        <h2>Autarkie & Eigennutzung (%)</h2>
        <div class="full-chart-container"><canvas id="chartAutarky"></canvas></div>
    </div>
</div>

<script>
    let sunStore = {}; 
    let wpStore = {};
    let charts = {};

    function cleanNum(val) {
        if (!val || val === "-" || val === "") return 0;
        let s = val.toString().replace(/\./g, '').replace(',', '.');
        return parseFloat(s) || 0;
    }

    // Automatisches Laden fÃ¼r den Hoster
    window.onload = () => {
        ['solar.csv', 'wp.csv'].forEach(file => {
            fetch(file).then(r => r.ok ? r.text() : null).then(text => {
                if(text) {
                    if (text.includes("PvToSite")) sunStore = parseSun(text); else wpStore = parseWp(text);
                    render();
                }
            });
        });
    };

    function parseWp(csvText) {
        const rows = Papa.parse(csvText.trim(), {delimiter: ";", skipEmptyLines: true}).data;
        const monthly = {};
        rows.forEach(row => {
            if ((row[0]||"").toString().toLowerCase() === "monat") {
                let key = row[1];
                if (key.includes(".")) {
                    const p = key.split(".");
                    key = `${p[p.length-1]}-${p[p.length-2].padStart(2, '0')}`;
                }
                // HIER WIEDER ORIGINAL-LOGIK: elec = m + r
                const h = cleanNum(row[7]), m = cleanNum(row[12]), r = cleanNum(row[17]);
                const v = cleanNum(row[21]), w = cleanNum(row[22]);
                if (m+r > 0 || h > 0) {
                    monthly[key] = { elec: (m + r), heat: (h+m+r), tAussen: v, tVorlauf: w, hasHeat: h > 0.5 };
                }
            }
        });
        return monthly;
    }

    function parseSun(csvText) {
        const rows = Papa.parse(csvText, {header: true, skipEmptyLines: true}).data;
        const monthly = {};
        rows.forEach(row => {
            const time = row.Time || row.time || "";
            if (time.length < 7) return;
            const key = time.substring(0, 7);
            if (!monthly[key]) monthly[key] = { grid: 0, self: 0, feed: 0 };
            monthly[key].grid += parseFloat(row.GridToSite) || 0;
            monthly[key].self += (parseFloat(row.PvToSite) || 0) + (parseFloat(row.BatteryToSite) || 0);
            monthly[key].feed += parseFloat(row.PvToGrid) || 0;
        });
        return monthly;
    }

    function render() {
        const sorted = Array.from(new Set([...Object.keys(sunStore), ...Object.keys(wpStore)])).sort();
        if (sorted.length === 0) return;

        const data = sorted.map(m => {
            const wpElec = wpStore[m]?.elec || 0;
            const self = sunStore[m]?.self || 0;
            const feed = sunStore[m]?.feed || 0;
            const grid = sunStore[m]?.grid || 0;
            const pvGen = self + feed;
            const totalNeed = self + grid;
            
            return { 
                m, ...sunStore[m], ...wpStore[m],
                pvGen: pvGen,
                housePure: Math.max(0, self - wpElec),
                wpElec: wpElec,
                autarky: totalNeed > 0 ? (self / totalNeed * 100) : 0,
                usage: pvGen > 0 ? (self / pvGen * 100) : 0
            };
        });

        const tGrid = data.reduce((s,d)=>s+(d.grid||0),0);
        const tSelf = data.reduce((s,d)=>s+(d.self||0),0);
        const tPv = data.reduce((s,d)=>s+d.pvGen,0);
        
        document.getElementById('txtPvTotal').innerText = tPv.toFixed(0) + " kWh";
        document.getElementById('txtPvUsageKwh').innerText = tSelf.toFixed(0) + " kWh";
        document.getElementById('txtPvUsagePct').innerText = (tPv > 0) ? (tSelf/tPv*100).toFixed(1) + "%" : "-";
        document.getElementById('txtAutarky').innerText = (tGrid+tSelf > 0) ? (tSelf/(tGrid+tSelf)*100).toFixed(1)+"%" : "-";
        
        const active = data.filter(d => d.hasHeat);
        document.getElementById('txtJaz').innerText = active.reduce((s,d)=>s+d.elec,0) > 0 ? (active.reduce((s,d)=>s+d.heat,0)/active.reduce((s,d)=>s+d.elec,0)).toFixed(2) : "-";
        document.getElementById('txtWpTotal').innerText = data.reduce((s,d)=>s+d.wpElec,0).toFixed(0)+" kWh";
        document.getElementById('txtGridTotal').innerText = tGrid.toFixed(0)+" kWh";

        Object.values(charts).forEach(c => { if(c) c.destroy(); });

        charts.main = new Chart(document.getElementById('chartMain'), {
            type: 'bar',
            data: {
                labels: sorted,
                datasets: [
                    { label: 'PV Erzeugung', data: data.map(d=>d.pvGen), backgroundColor: '#f1c40f', stack: '0' },
                    { label: 'Einspeisung', data: data.map(d=>d.feed||0), backgroundColor: '#e67e22', stack: '1' },
                    { label: 'Haus (Eigen)', data: data.map(d=>d.housePure), backgroundColor: '#2ecc71', stack: '2' },
                    { label: 'WP (Eigen)', data: data.map(d=>d.wpElec), backgroundColor: '#9b59b6', stack: '2' },
                    { label: 'Netzbezug', data: data.map(d=>d.grid||0), backgroundColor: '#e74c3c', stack: '3' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        charts.eff = new Chart(document.getElementById('chartEff'), {
            type: 'line',
            data: { labels: sorted, datasets: [{ label: 'JAZ', data: data.map(d=>(d.hasHeat && d.elec>0)?(d.heat/d.elec).toFixed(2):null), borderColor: '#e67e22', tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        charts.temp = new Chart(document.getElementById('chartHeizBalken'), {
            type: 'bar',
            data: {
                labels: data.filter(d=>d.hasHeat).map(d=>d.m),
                datasets: [ { label: 'AuÃŸen', data: data.filter(d=>d.hasHeat).map(d=>d.tAussen||0), backgroundColor: '#3498db' }, { label: 'Vorlauf', data: data.filter(d=>d.hasHeat).map(d=>d.tVorlauf||0), backgroundColor: '#e74c3c' } ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        charts.aut = new Chart(document.getElementById('chartAutarky'), {
            type: 'line',
            data: {
                labels: sorted,
                datasets: [
                    { label: 'Autarkie (%)', data: data.map(d=>d.autarky.toFixed(1)), borderColor: '#2ecc71', tension: 0.3 },
                    { label: 'PV Nutzung (%)', data: data.map(d=>d.usage.toFixed(1)), borderColor: '#2980b9', tension: 0.3 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    document.getElementById('fileInput').onchange = e => {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const text = ev.target.result;
                if (text.includes("PvToSite")) sunStore = parseSun(text); else wpStore = parseWp(text);
                render();
            };
            reader.readAsText(file);
        });
    };
</script>
</body>
</html>